<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€šçŸ¥ç³»ç»Ÿæµ‹è¯• UI</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .json-editor {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            transform: translateX(400px);
            transition: transform 0.3s ease-in-out;
            z-index: 50;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .tab-content {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* ä»£ç é«˜äº® */
        .hljs-string { color: #0d9b55; }
        .hljs-number { color: #0066cc; }
        .hljs-boolean { color: #ff6b6b; }
        .hljs-null { color: #868e96; }
        .hljs-key { color: #5c2e91; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef, useMemo } = React;

        // ========== é€šç”¨ç»„ä»¶ ==========
        function Toast({ message, type, show, onClose }) {
            useEffect(() => {
                if (show) {
                    const timer = setTimeout(onClose, 3000);
                    return () => clearTimeout(timer);
                }
            }, [show, onClose]);

            const bgColor = type === 'success' ? 'bg-green-500' : 
                           type === 'error' ? 'bg-red-500' : 
                           type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500';

            return (
                <div className={`toast ${show ? 'show' : ''} ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg`}>
                    <div className="flex items-center">
                        <span>{message}</span>
                        <button
                            onClick={onClose}
                            className="ml-4 text-white hover:text-gray-200"
                        >
                            Ã—
                        </button>
                    </div>
                </div>
            );
        }

        function JsonEditor({ value, onChange, height = '200px', readOnly = false }) {
            const [internalValue, setInternalValue] = useState('');
            const [error, setError] = useState('');

            useEffect(() => {
                try {
                    const formatted = JSON.stringify(value, null, 2);
                    setInternalValue(formatted);
                    setError('');
                } catch (e) {
                    setInternalValue(String(value));
                    setError('Invalid JSON');
                }
            }, [value]);

            const handleChange = (e) => {
                const newValue = e.target.value;
                setInternalValue(newValue);

                try {
                    const parsed = JSON.parse(newValue);
                    onChange(parsed);
                    setError('');
                } catch (e) {
                    setError('Invalid JSON: ' + e.message);
                }
            };

            return (
                <div className="relative">
                    <textarea
                        value={internalValue}
                        onChange={handleChange}
                        readOnly={readOnly}
                        className={`json-editor w-full p-3 bg-gray-50 border rounded-lg custom-scrollbar ${
                            error ? 'border-red-500' : 'border-gray-300'
                        } ${readOnly ? 'bg-gray-100' : ''}`}
                        style={{ height }}
                        spellCheck="false"
                    />
                    {error && (
                        <div className="absolute bottom-0 left-0 text-xs text-red-500 mt-1">
                            {error}
                        </div>
                    )}
                </div>
            );
        }

        function Select({ value, onChange, options, placeholder = 'è¯·é€‰æ‹©...' }) {
            return (
                <select
                    value={value}
                    onChange={(e) => onChange(e.target.value)}
                    className="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                    <option value="">{placeholder}</option>
                    {options.map(option => (
                        <option key={option.value} value={option.value}>
                            {option.label}
                        </option>
                    ))}
                </select>
            );
        }

        function Card({ title, children, actions }) {
            return (
                <div className="bg-white rounded-lg shadow-md">
                    <div className="px-6 py-4 border-b border-gray-200">
                        <div className="flex justify-between items-center">
                            <h3 className="text-lg font-semibold text-gray-800">{title}</h3>
                            {actions && <div className="flex gap-2">{actions}</div>}
                        </div>
                    </div>
                    <div className="p-6">{children}</div>
                </div>
            );
        }

        function Button({ onClick, children, variant = 'primary', size = 'md', disabled = false, loading = false }) {
            const baseClasses = 'font-medium rounded-lg transition-colors duration-200 flex items-center justify-center';
            
            const sizeClasses = {
                sm: 'px-3 py-1.5 text-sm',
                md: 'px-4 py-2',
                lg: 'px-6 py-3 text-lg'
            };

            const variantClasses = {
                primary: 'bg-blue-500 text-white hover:bg-blue-600 disabled:bg-blue-300',
                secondary: 'bg-gray-200 text-gray-800 hover:bg-gray-300 disabled:bg-gray-100',
                danger: 'bg-red-500 text-white hover:bg-red-600 disabled:bg-red-300',
                success: 'bg-green-500 text-white hover:bg-green-600 disabled:bg-green-300',
                ghost: 'text-gray-600 hover:bg-gray-100'
            };

            return (
                <button
                    onClick={onClick}
                    disabled={disabled || loading}
                    className={`${baseClasses} ${sizeClasses[size]} ${variantClasses[variant]} ${
                        disabled || loading ? 'cursor-not-allowed opacity-60' : ''
                    }`}
                >
                    {loading && <div className="spinner mr-2" />}
                    {children}
                </button>
            );
        }

        // ========== API é…ç½® ==========
        const API_CONFIG = {
            getBaseUrl: () => {
                const saved = localStorage.getItem('notification_api_url');
                return saved || window.location.origin;
            },
            setBaseUrl: (url) => {
                localStorage.setItem('notification_api_url', url);
            },
            getApiKey: () => {
                return localStorage.getItem('notification_api_key') || '';
            },
            setApiKey: (key) => {
                localStorage.setItem('notification_api_key', key);
            }
        };

        // ========== API å®¢æˆ·ç«¯ ==========
        class ApiClient {
            constructor() {
                this.baseUrl = API_CONFIG.getBaseUrl();
                this.apiKey = API_CONFIG.getApiKey();
            }

            setCredentials(baseUrl, apiKey) {
                this.baseUrl = baseUrl;
                this.apiKey = apiKey;
                API_CONFIG.setBaseUrl(baseUrl);
                API_CONFIG.setApiKey(apiKey);
            }

            generateSignature(timestamp, payload) {
                return CryptoJS.HmacSHA256(timestamp + payload, this.apiKey).toString();
            }

            async request(path, method = 'GET', body = null) {
                const url = `${this.baseUrl}${path}`;
                const timestamp = Date.now().toString();
                
                let payload = '';
                if (method === 'GET' || method === 'DELETE') {
                    const urlObj = new URL(url);
                    payload = urlObj.pathname + urlObj.search;
                } else if (body) {
                    payload = JSON.stringify(body);
                }

                const headers = {
                    'Content-Type': 'application/json',
                    'X-Timestamp': timestamp,
                    'X-Signature': this.generateSignature(timestamp, payload)
                };

                const options = {
                    method,
                    headers
                };

                if (body && method !== 'GET' && method !== 'DELETE') {
                    options.body = JSON.stringify(body);
                }

                const response = await fetch(url, options);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || `HTTP ${response.status}`);
                }

                return data;
            }

            // API æ–¹æ³•
            async sendNotification(data) {
                return this.request('/api/notifications/send', 'POST', data);
            }

            async getUserConfigs(userId) {
                return this.request(`/api/user-configs?user_id=${encodeURIComponent(userId)}`);
            }

            async setUserConfig(userId, channelType, config) {
                return this.request('/api/user-configs', 'POST', {
                    user_id: userId,
                    channel_type: channelType,
                    config_data: config,
                    is_active: true
                });
            }

            async getTemplates() {
                return this.request('/api/templates');
            }

            async createTemplate(key, template) {
                return this.request(`/api/templates?key=${encodeURIComponent(key)}`, 'POST', template);
            }

            async deleteTemplate(key) {
                return this.request(`/api/templates?key=${encodeURIComponent(key)}`, 'DELETE');
            }

            async getNotificationLogs(params = {}) {
                const queryParams = new URLSearchParams(params);
                return this.request(`/api/notification-logs?${queryParams}`);
            }

            async checkHealth() {
                return this.request('/health');
            }
        }

        // ========== ä¸»åº”ç”¨ ==========
        function App() {
            const [activeTab, setActiveTab] = useState('send');
            const [apiKey, setApiKey] = useState(API_CONFIG.getApiKey());
            const [baseUrl, setBaseUrl] = useState(API_CONFIG.getBaseUrl());
            const [toast, setToast] = useState({ show: false, message: '', type: 'info' });
            const [isHealthy, setIsHealthy] = useState(false);
            const [loading, setLoading] = useState(false);

            const apiClient = useRef(new ApiClient());

            const showToast = useCallback((message, type = 'info') => {
                setToast({ show: true, message, type });
            }, []);

            const checkHealth = useCallback(async () => {
                if (!apiKey || !baseUrl) return;
                
                try {
                    setLoading(true);
                    apiClient.current.setCredentials(baseUrl, apiKey);
                    const result = await apiClient.current.checkHealth();
                    setIsHealthy(true);
                    showToast('API è¿æ¥æˆåŠŸ', 'success');
                } catch (error) {
                    setIsHealthy(false);
                    showToast('API è¿æ¥å¤±è´¥: ' + error.message, 'error');
                }
                setLoading(false);
            }, [apiKey, baseUrl, showToast]);

            useEffect(() => {
                if (apiKey && baseUrl) {
                    checkHealth();
                }
            }, []);

            const tabs = [
                { id: 'send', label: 'å‘é€é€šçŸ¥', icon: 'ğŸ“¤' },
                { id: 'config', label: 'ç”¨æˆ·é…ç½®', icon: 'âš™ï¸' },
                { id: 'template', label: 'æ¨¡æ¿ç®¡ç†', icon: 'ğŸ“' },
                { id: 'logs', label: 'é€šçŸ¥æ—¥å¿—', icon: 'ğŸ“Š' },
                { id: 'settings', label: 'è®¾ç½®', icon: 'ğŸ”§' }
            ];

            return (
                <div className="min-h-screen bg-gray-50">
                    {/* Header */}
                    <header className="bg-white shadow-sm border-b">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center py-4">
                                <div className="flex items-center">
                                    <h1 className="text-2xl font-bold text-gray-900">é€šçŸ¥ç³»ç»Ÿæµ‹è¯• UI</h1>
                                    <div className="ml-4">
                                        {isHealthy ? (
                                            <span className="text-green-500 text-sm">â— å·²è¿æ¥</span>
                                        ) : (
                                            <span className="text-red-500 text-sm">â— æœªè¿æ¥</span>
                                        )}
                                    </div>
                                </div>
                                <Button onClick={checkHealth} variant="ghost" size="sm" loading={loading}>
                                    åˆ·æ–°çŠ¶æ€
                                </Button>
                            </div>
                        </div>
                    </header>

                    {/* Navigation */}
                    <nav className="bg-white border-b">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex space-x-8">
                                {tabs.map(tab => (
                                    <button
                                        key={tab.id}
                                        onClick={() => setActiveTab(tab.id)}
                                        className={`py-3 px-1 border-b-2 font-medium text-sm transition-colors ${
                                            activeTab === tab.id
                                                ? 'border-blue-500 text-blue-600'
                                                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                                        }`}
                                    >
                                        <span className="mr-2">{tab.icon}</span>
                                        {tab.label}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </nav>

                    {/* Content */}
                    <main className="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
                        <div className="tab-content">
                            {activeTab === 'send' && (
                                <SendNotification apiClient={apiClient.current} showToast={showToast} />
                            )}
                            {activeTab === 'config' && (
                                <UserConfig apiClient={apiClient.current} showToast={showToast} />
                            )}
                            {activeTab === 'template' && (
                                <TemplateManagement apiClient={apiClient.current} showToast={showToast} />
                            )}
                            {activeTab === 'logs' && (
                                <NotificationLogs apiClient={apiClient.current} showToast={showToast} />
                            )}
                            {activeTab === 'settings' && (
                                <Settings 
                                    apiKey={apiKey} 
                                    setApiKey={setApiKey}
                                    baseUrl={baseUrl}
                                    setBaseUrl={setBaseUrl}
                                    onSave={checkHealth}
                                    showToast={showToast}
                                />
                            )}
                        </div>
                    </main>

                    {/* Toast */}
                    <Toast
                        message={toast.message}
                        type={toast.type}
                        show={toast.show}
                        onClose={() => setToast({ ...toast, show: false })}
                    />
                </div>
            );
        }

        // ========== å‘é€é€šçŸ¥ç»„ä»¶ ==========
        function SendNotification({ apiClient, showToast }) {
            const [userId, setUserId] = useState('test-user');
            const [channels, setChannels] = useState(['lark']);
            const [sendMode, setSendMode] = useState('custom'); // 'custom' or 'template'
            const [templateKey, setTemplateKey] = useState('');
            const [customContent, setCustomContent] = useState({
                subject: 'æµ‹è¯•é€šçŸ¥',
                content: 'è¿™æ˜¯ä¸€æ¡æµ‹è¯•é€šçŸ¥æ¶ˆæ¯'
            });
            const [variables, setVariables] = useState({});
            const [idempotencyKey, setIdempotencyKey] = useState('');
            const [loading, setLoading] = useState(false);
            const [response, setResponse] = useState(null);
            const [templates, setTemplates] = useState([]);

            useEffect(() => {
                loadTemplates();
            }, []);

            const loadTemplates = async () => {
                try {
                    const result = await apiClient.getTemplates();
                    if (result.templates) {
                        setTemplates(Object.keys(result.templates));
                    }
                } catch (error) {
                    console.error('Failed to load templates:', error);
                }
            };

            const handleSend = async () => {
                try {
                    setLoading(true);
                    const payload = {
                        user_id: userId,
                        channels: channels
                    };

                    if (sendMode === 'template') {
                        payload.template_key = templateKey;
                        if (Object.keys(variables).length > 0) {
                            payload.variables = variables;
                        }
                    } else {
                        payload.custom_content = customContent;
                    }

                    if (idempotencyKey) {
                        payload.idempotency_key = idempotencyKey;
                    }

                    const result = await apiClient.sendNotification(payload);
                    setResponse(result);
                    showToast('é€šçŸ¥å‘é€æˆåŠŸ', 'success');
                } catch (error) {
                    showToast('å‘é€å¤±è´¥: ' + error.message, 'error');
                }
                setLoading(false);
            };

            const channelOptions = [
                { value: 'lark', label: 'é£ä¹¦ (Lark)' },
                { value: 'telegram', label: 'Telegram' },
                { value: 'webhook', label: 'Webhook' },
                { value: 'slack', label: 'Slack' }
            ];

            return (
                <div className="space-y-6">
                    <Card title="å‘é€é€šçŸ¥">
                        <div className="space-y-4">
                            {/* ç”¨æˆ· ID */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    ç”¨æˆ· ID
                                </label>
                                <input
                                    type="text"
                                    value={userId}
                                    onChange={(e) => setUserId(e.target.value)}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="è¾“å…¥ç”¨æˆ· ID"
                                />
                            </div>

                            {/* é€šçŸ¥æ¸ é“ */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    é€šçŸ¥æ¸ é“
                                </label>
                                <div className="space-y-2">
                                    {channelOptions.map(option => (
                                        <label key={option.value} className="flex items-center">
                                            <input
                                                type="checkbox"
                                                value={option.value}
                                                checked={channels.includes(option.value)}
                                                onChange={(e) => {
                                                    if (e.target.checked) {
                                                        setChannels([...channels, option.value]);
                                                    } else {
                                                        setChannels(channels.filter(c => c !== option.value));
                                                    }
                                                }}
                                                className="mr-2"
                                            />
                                            {option.label}
                                        </label>
                                    ))}
                                </div>
                            </div>

                            {/* å‘é€æ¨¡å¼ */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    å‘é€æ¨¡å¼
                                </label>
                                <div className="flex space-x-4">
                                    <label className="flex items-center">
                                        <input
                                            type="radio"
                                            value="custom"
                                            checked={sendMode === 'custom'}
                                            onChange={(e) => setSendMode(e.target.value)}
                                            className="mr-2"
                                        />
                                        è‡ªå®šä¹‰å†…å®¹
                                    </label>
                                    <label className="flex items-center">
                                        <input
                                            type="radio"
                                            value="template"
                                            checked={sendMode === 'template'}
                                            onChange={(e) => setSendMode(e.target.value)}
                                            className="mr-2"
                                        />
                                        ä½¿ç”¨æ¨¡æ¿
                                    </label>
                                </div>
                            </div>

                            {/* æ ¹æ®æ¨¡å¼æ˜¾ç¤ºä¸åŒå†…å®¹ */}
                            {sendMode === 'custom' ? (
                                <>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            ä¸»é¢˜
                                        </label>
                                        <input
                                            type="text"
                                            value={customContent.subject}
                                            onChange={(e) => setCustomContent({
                                                ...customContent,
                                                subject: e.target.value
                                            })}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            placeholder="é€šçŸ¥ä¸»é¢˜"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            å†…å®¹
                                        </label>
                                        <textarea
                                            value={customContent.content}
                                            onChange={(e) => setCustomContent({
                                                ...customContent,
                                                content: e.target.value
                                            })}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            rows="4"
                                            placeholder="é€šçŸ¥å†…å®¹"
                                        />
                                    </div>
                                </>
                            ) : (
                                <>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            é€‰æ‹©æ¨¡æ¿
                                        </label>
                                        <Select
                                            value={templateKey}
                                            onChange={setTemplateKey}
                                            options={templates.map(t => ({ value: t, label: t }))}
                                            placeholder="é€‰æ‹©ä¸€ä¸ªæ¨¡æ¿"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            æ¨¡æ¿å˜é‡ (JSON)
                                        </label>
                                        <JsonEditor
                                            value={variables}
                                            onChange={setVariables}
                                            height="100px"
                                        />
                                    </div>
                                </>
                            )}

                            {/* å¹‚ç­‰é”® */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    å¹‚ç­‰é”®ï¼ˆå¯é€‰ï¼‰
                                </label>
                                <input
                                    type="text"
                                    value={idempotencyKey}
                                    onChange={(e) => setIdempotencyKey(e.target.value)}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="é˜²æ­¢é‡å¤å‘é€çš„å”¯ä¸€é”®"
                                />
                            </div>

                            {/* å‘é€æŒ‰é’® */}
                            <div className="flex justify-end">
                                <Button 
                                    onClick={handleSend} 
                                    disabled={!userId || channels.length === 0}
                                    loading={loading}
                                >
                                    å‘é€é€šçŸ¥
                                </Button>
                            </div>
                        </div>
                    </Card>

                    {/* å“åº”ç»“æœ */}
                    {response && (
                        <Card title="å‘é€ç»“æœ">
                            <JsonEditor value={response} readOnly height="300px" />
                        </Card>
                    )}
                </div>
            );
        }

        // ========== ç”¨æˆ·é…ç½®ç»„ä»¶ ==========
        function UserConfig({ apiClient, showToast }) {
            const [userId, setUserId] = useState('test-user');
            const [configs, setConfigs] = useState([]);
            const [loading, setLoading] = useState(false);
            const [editingConfig, setEditingConfig] = useState(null);
            const [newConfig, setNewConfig] = useState({
                channel_type: '',
                config: {}
            });

            const loadConfigs = async () => {
                if (!userId) return;
                
                try {
                    setLoading(true);
                    const result = await apiClient.getUserConfigs(userId);
                    setConfigs(result.configs || []);
                } catch (error) {
                    showToast('åŠ è½½é…ç½®å¤±è´¥: ' + error.message, 'error');
                }
                setLoading(false);
            };

            const saveConfig = async (channelType, config) => {
                try {
                    await apiClient.setUserConfig(userId, channelType, config);
                    showToast('é…ç½®ä¿å­˜æˆåŠŸ', 'success');
                    loadConfigs();
                    setEditingConfig(null);
                } catch (error) {
                    showToast('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
                }
            };

            const getConfigTemplate = (channelType) => {
                const templates = {
                    lark: {
                        webhook_url: 'https://open.feishu.cn/open-apis/bot/v2/hook/xxx',
                        secret: 'your-secret',
                        msg_type: 'text'
                    },
                    telegram: {
                        bot_token: 'your-bot-token',
                        chat_id: 'your-chat-id'
                    },
                    webhook: {
                        webhook_url: 'https://your-webhook-url.com',
                        method: 'POST',
                        headers: {}
                    },
                    slack: {
                        webhook_url: 'https://hooks.slack.com/services/xxx'
                    }
                };
                return templates[channelType] || {};
            };

            return (
                <div className="space-y-6">
                    <Card title="ç”¨æˆ·é…ç½®ç®¡ç†">
                        <div className="space-y-4">
                            <div className="flex gap-4">
                                <input
                                    type="text"
                                    value={userId}
                                    onChange={(e) => setUserId(e.target.value)}
                                    className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="è¾“å…¥ç”¨æˆ· ID"
                                />
                                <Button onClick={loadConfigs} loading={loading}>
                                    åŠ è½½é…ç½®
                                </Button>
                            </div>

                            {configs.length > 0 && (
                                <div className="space-y-4">
                                    <h4 className="font-medium text-gray-700">ç°æœ‰é…ç½®</h4>
                                    {configs.map(config => (
                                        <div key={config.channel_type} className="bg-gray-50 p-4 rounded-lg">
                                            <div className="flex justify-between items-start">
                                                <div className="flex-1">
                                                    <h5 className="font-medium">{config.channel_type}</h5>
                                                    <p className="text-sm text-gray-500">
                                                        çŠ¶æ€: {config.is_active ? 'âœ… å¯ç”¨' : 'âŒ ç¦ç”¨'}
                                                    </p>
                                                    {editingConfig === config.channel_type ? (
                                                        <div className="mt-2">
                                                            <JsonEditor
                                                                value={config.config}
                                                                onChange={(newConfig) => {
                                                                    const updated = configs.map(c => 
                                                                        c.channel_type === config.channel_type
                                                                            ? { ...c, config: newConfig }
                                                                            : c
                                                                    );
                                                                    setConfigs(updated);
                                                                }}
                                                                height="150px"
                                                            />
                                                            <div className="mt-2 flex gap-2">
                                                                <Button
                                                                    size="sm"
                                                                    onClick={() => saveConfig(config.channel_type, config.config)}
                                                                >
                                                                    ä¿å­˜
                                                                </Button>
                                                                <Button
                                                                    size="sm"
                                                                    variant="secondary"
                                                                    onClick={() => setEditingConfig(null)}
                                                                >
                                                                    å–æ¶ˆ
                                                                </Button>
                                                            </div>
                                                        </div>
                                                    ) : (
                                                        <div className="mt-2">
                                                            <pre className="text-xs bg-white p-2 rounded">
                                                                {JSON.stringify(config.config, null, 2)}
                                                            </pre>
                                                            <Button
                                                                size="sm"
                                                                variant="ghost"
                                                                onClick={() => setEditingConfig(config.channel_type)}
                                                            >
                                                                ç¼–è¾‘
                                                            </Button>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}

                            <div>
                                <h4 className="font-medium text-gray-700 mb-2">æ·»åŠ æ–°é…ç½®</h4>
                                <div className="space-y-3">
                                    <Select
                                        value={newConfig.channel_type}
                                        onChange={(value) => {
                                            setNewConfig({
                                                channel_type: value,
                                                config: getConfigTemplate(value)
                                            });
                                        }}
                                        options={[
                                            { value: 'lark', label: 'é£ä¹¦ (Lark)' },
                                            { value: 'telegram', label: 'Telegram' },
                                            { value: 'webhook', label: 'Webhook' },
                                            { value: 'slack', label: 'Slack' }
                                        ]}
                                    />
                                    {newConfig.channel_type && (
                                        <>
                                            <JsonEditor
                                                value={newConfig.config}
                                                onChange={(config) => setNewConfig({ ...newConfig, config })}
                                                height="200px"
                                            />
                                            <Button
                                                onClick={() => saveConfig(newConfig.channel_type, newConfig.config)}
                                            >
                                                æ·»åŠ é…ç½®
                                            </Button>
                                        </>
                                    )}
                                </div>
                            </div>
                        </div>
                    </Card>
                </div>
            );
        }

        // ========== æ¨¡æ¿ç®¡ç†ç»„ä»¶ ==========
        function TemplateManagement({ apiClient, showToast }) {
            const [templates, setTemplates] = useState({});
            const [loading, setLoading] = useState(false);
            const [editingTemplate, setEditingTemplate] = useState(null);
            const [newTemplate, setNewTemplate] = useState({
                key: '',
                name: '',
                description: '',
                variables: [],
                contents: {}
            });

            useEffect(() => {
                loadTemplates();
            }, []);

            const loadTemplates = async () => {
                try {
                    setLoading(true);
                    const result = await apiClient.getTemplates();
                    setTemplates(result.templates || {});
                } catch (error) {
                    showToast('åŠ è½½æ¨¡æ¿å¤±è´¥: ' + error.message, 'error');
                }
                setLoading(false);
            };

            const saveTemplate = async (key, template) => {
                try {
                    await apiClient.createTemplate(key, template);
                    showToast('æ¨¡æ¿ä¿å­˜æˆåŠŸ', 'success');
                    loadTemplates();
                    setEditingTemplate(null);
                    setNewTemplate({
                        key: '',
                        name: '',
                        description: '',
                        variables: [],
                        contents: {}
                    });
                } catch (error) {
                    showToast('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
                }
            };

            const deleteTemplate = async (key) => {
                if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¨¡æ¿å—ï¼Ÿ')) return;
                
                try {
                    await apiClient.deleteTemplate(key);
                    showToast('æ¨¡æ¿åˆ é™¤æˆåŠŸ', 'success');
                    loadTemplates();
                } catch (error) {
                    showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
                }
            };

            return (
                <div className="space-y-6">
                    <Card 
                        title="æ¨¡æ¿ç®¡ç†" 
                        actions={
                            <Button onClick={loadTemplates} variant="ghost" size="sm" loading={loading}>
                                åˆ·æ–°
                            </Button>
                        }
                    >
                        <div className="space-y-4">
                            {Object.entries(templates).map(([key, template]) => (
                                <div key={key} className="bg-gray-50 p-4 rounded-lg">
                                    <div className="flex justify-between items-start">
                                        <div className="flex-1">
                                            <h4 className="font-medium">{template.name || key}</h4>
                                            <p className="text-sm text-gray-500">{template.description}</p>
                                            <p className="text-xs text-gray-400 mt-1">
                                                é”®å: {key} | å˜é‡: {template.variables?.join(', ') || 'æ— '}
                                            </p>
                                            {editingTemplate === key ? (
                                                <div className="mt-3">
                                                    <JsonEditor
                                                        value={template}
                                                        onChange={(updated) => {
                                                            setTemplates({
                                                                ...templates,
                                                                [key]: updated
                                                            });
                                                        }}
                                                        height="300px"
                                                    />
                                                    <div className="mt-2 flex gap-2">
                                                        <Button
                                                            size="sm"
                                                            onClick={() => saveTemplate(key, templates[key])}
                                                        >
                                                            ä¿å­˜
                                                        </Button>
                                                        <Button
                                                            size="sm"
                                                            variant="secondary"
                                                            onClick={() => {
                                                                setEditingTemplate(null);
                                                                loadTemplates();
                                                            }}
                                                        >
                                                            å–æ¶ˆ
                                                        </Button>
                                                    </div>
                                                </div>
                                            ) : (
                                                <div className="mt-2 flex gap-2">
                                                    <Button
                                                        size="sm"
                                                        variant="ghost"
                                                        onClick={() => setEditingTemplate(key)}
                                                    >
                                                        ç¼–è¾‘
                                                    </Button>
                                                    <Button
                                                        size="sm"
                                                        variant="danger"
                                                        onClick={() => deleteTemplate(key)}
                                                    >
                                                        åˆ é™¤
                                                    </Button>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            ))}

                            <div className="mt-6">
                                <h4 className="font-medium text-gray-700 mb-3">åˆ›å»ºæ–°æ¨¡æ¿</h4>
                                <div className="space-y-3">
                                    <input
                                        type="text"
                                        value={newTemplate.key}
                                        onChange={(e) => setNewTemplate({ ...newTemplate, key: e.target.value })}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="æ¨¡æ¿é”®åï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰"
                                    />
                                    <input
                                        type="text"
                                        value={newTemplate.name}
                                        onChange={(e) => setNewTemplate({ ...newTemplate, name: e.target.value })}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="æ¨¡æ¿åç§°"
                                    />
                                    <textarea
                                        value={newTemplate.description}
                                        onChange={(e) => setNewTemplate({ ...newTemplate, description: e.target.value })}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="æ¨¡æ¿æè¿°"
                                        rows="2"
                                    />
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            æ¨¡æ¿å†…å®¹ (JSON)
                                        </label>
                                        <JsonEditor
                                            value={newTemplate}
                                            onChange={setNewTemplate}
                                            height="300px"
                                        />
                                    </div>
                                    <Button
                                        onClick={() => saveTemplate(newTemplate.key, newTemplate)}
                                        disabled={!newTemplate.key || !newTemplate.name}
                                    >
                                        åˆ›å»ºæ¨¡æ¿
                                    </Button>
                                </div>
                            </div>
                        </div>
                    </Card>
                </div>
            );
        }

        // ========== é€šçŸ¥æ—¥å¿—ç»„ä»¶ ==========
        function NotificationLogs({ apiClient, showToast }) {
            const [logs, setLogs] = useState([]);
            const [loading, setLoading] = useState(false);
            const [filters, setFilters] = useState({
                user_id: '',
                status: '',
                channel_type: '',
                limit: 20
            });

            const loadLogs = async () => {
                try {
                    setLoading(true);
                    const params = {};
                    Object.entries(filters).forEach(([key, value]) => {
                        if (value) params[key] = value;
                    });
                    
                    const result = await apiClient.getNotificationLogs(params);
                    setLogs(result.logs || []);
                } catch (error) {
                    showToast('åŠ è½½æ—¥å¿—å¤±è´¥: ' + error.message, 'error');
                }
                setLoading(false);
            };

            useEffect(() => {
                loadLogs();
            }, []);

            const formatDate = (dateString) => {
                return new Date(dateString).toLocaleString('zh-CN');
            };

            const getStatusBadge = (status) => {
                const statusMap = {
                    'sent': { label: 'å·²å‘é€', class: 'bg-green-100 text-green-800' },
                    'failed': { label: 'å¤±è´¥', class: 'bg-red-100 text-red-800' },
                    'pending': { label: 'å¾…å‘é€', class: 'bg-yellow-100 text-yellow-800' },
                    'retry': { label: 'é‡è¯•ä¸­', class: 'bg-blue-100 text-blue-800' }
                };
                const config = statusMap[status] || { label: status, class: 'bg-gray-100 text-gray-800' };
                return (
                    <span className={`px-2 py-1 text-xs rounded-full ${config.class}`}>
                        {config.label}
                    </span>
                );
            };

            return (
                <div className="space-y-6">
                    <Card title="é€šçŸ¥æ—¥å¿—">
                        <div className="space-y-4">
                            {/* ç­›é€‰å™¨ */}
                            <div className="grid grid-cols-4 gap-4">
                                <input
                                    type="text"
                                    value={filters.user_id}
                                    onChange={(e) => setFilters({ ...filters, user_id: e.target.value })}
                                    className="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="ç”¨æˆ· ID"
                                />
                                <Select
                                    value={filters.status}
                                    onChange={(value) => setFilters({ ...filters, status: value })}
                                    options={[
                                        { value: 'sent', label: 'å·²å‘é€' },
                                        { value: 'failed', label: 'å¤±è´¥' },
                                        { value: 'pending', label: 'å¾…å‘é€' },
                                        { value: 'retry', label: 'é‡è¯•ä¸­' }
                                    ]}
                                    placeholder="çŠ¶æ€"
                                />
                                <Select
                                    value={filters.channel_type}
                                    onChange={(value) => setFilters({ ...filters, channel_type: value })}
                                    options={[
                                        { value: 'lark', label: 'é£ä¹¦' },
                                        { value: 'telegram', label: 'Telegram' },
                                        { value: 'webhook', label: 'Webhook' },
                                        { value: 'slack', label: 'Slack' }
                                    ]}
                                    placeholder="æ¸ é“"
                                />
                                <Button onClick={loadLogs} loading={loading}>
                                    æŸ¥è¯¢
                                </Button>
                            </div>

                            {/* æ—¥å¿—è¡¨æ ¼ */}
                            <div className="overflow-x-auto">
                                <table className="min-w-full divide-y divide-gray-200">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                æ—¶é—´
                                            </th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                ç”¨æˆ·
                                            </th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                æ¸ é“
                                            </th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                çŠ¶æ€
                                            </th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                æ¶ˆæ¯ ID
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {logs.map((log) => (
                                            <tr key={log.id} className="hover:bg-gray-50">
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                    {formatDate(log.created_at)}
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                    {log.user_id}
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                    {log.channel_type}
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap">
                                                    {getStatusBadge(log.status)}
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                    {log.message_id || '-'}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>

                            {logs.length === 0 && (
                                <div className="text-center py-8 text-gray-500">
                                    æš‚æ— æ—¥å¿—è®°å½•
                                </div>
                            )}
                        </div>
                    </Card>
                </div>
            );
        }

        // ========== è®¾ç½®ç»„ä»¶ ==========
        function Settings({ apiKey, setApiKey, baseUrl, setBaseUrl, onSave, showToast }) {
            const [tempApiKey, setTempApiKey] = useState(apiKey);
            const [tempBaseUrl, setTempBaseUrl] = useState(baseUrl);
            const [showApiKey, setShowApiKey] = useState(false);

            const handleSave = () => {
                setApiKey(tempApiKey);
                setBaseUrl(tempBaseUrl);
                API_CONFIG.setApiKey(tempApiKey);
                API_CONFIG.setBaseUrl(tempBaseUrl);
                showToast('è®¾ç½®å·²ä¿å­˜', 'success');
                onSave();
            };

            return (
                <div className="space-y-6">
                    <Card title="API è®¾ç½®">
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    API åœ°å€
                                </label>
                                <input
                                    type="text"
                                    value={tempBaseUrl}
                                    onChange={(e) => setTempBaseUrl(e.target.value)}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="https://api.example.com"
                                />
                                <p className="mt-1 text-sm text-gray-500">
                                    é€šçŸ¥ç³»ç»Ÿ API çš„åŸºç¡€ URL
                                </p>
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    API å¯†é’¥
                                </label>
                                <div className="relative">
                                    <input
                                        type={showApiKey ? 'text' : 'password'}
                                        value={tempApiKey}
                                        onChange={(e) => setTempApiKey(e.target.value)}
                                        className="w-full px-3 py-2 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="è¾“å…¥ API å¯†é’¥"
                                    />
                                    <button
                                        type="button"
                                        onClick={() => setShowApiKey(!showApiKey)}
                                        className="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500 hover:text-gray-700"
                                    >
                                        {showApiKey ? 'ğŸ™ˆ' : 'ğŸ‘ï¸'}
                                    </button>
                                </div>
                                <p className="mt-1 text-sm text-gray-500">
                                    ç”¨äº HMAC-SHA256 ç­¾åéªŒè¯çš„å¯†é’¥
                                </p>
                            </div>

                            <div className="flex justify-end">
                                <Button onClick={handleSave}>
                                    ä¿å­˜è®¾ç½®
                                </Button>
                            </div>
                        </div>
                    </Card>

                    <Card title="ä½¿ç”¨è¯´æ˜">
                        <div className="prose prose-sm max-w-none">
                            <h4 className="text-base font-medium mb-2">å¿«é€Ÿå¼€å§‹</h4>
                            <ol className="list-decimal list-inside space-y-2 text-sm text-gray-700">
                                <li>åœ¨"è®¾ç½®"é¡µé¢é…ç½® API åœ°å€å’Œå¯†é’¥</li>
                                <li>åœ¨"ç”¨æˆ·é…ç½®"é¡µé¢ä¸ºç”¨æˆ·æ·»åŠ é€šçŸ¥æ¸ é“é…ç½®</li>
                                <li>åœ¨"æ¨¡æ¿ç®¡ç†"é¡µé¢åˆ›å»ºé€šçŸ¥æ¨¡æ¿ï¼ˆå¯é€‰ï¼‰</li>
                                <li>åœ¨"å‘é€é€šçŸ¥"é¡µé¢æµ‹è¯•å‘é€é€šçŸ¥</li>
                                <li>åœ¨"é€šçŸ¥æ—¥å¿—"é¡µé¢æŸ¥çœ‹å‘é€è®°å½•</li>
                            </ol>

                            <h4 className="text-base font-medium mt-4 mb-2">æ”¯æŒçš„é€šçŸ¥æ¸ é“</h4>
                            <ul className="list-disc list-inside space-y-1 text-sm text-gray-700">
                                <li><strong>é£ä¹¦ (Lark)</strong>: éœ€è¦é…ç½® webhook URL å’Œå¯†é’¥</li>
                                <li><strong>Telegram</strong>: éœ€è¦é…ç½® bot token å’Œ chat ID</li>
                                <li><strong>Webhook</strong>: æ”¯æŒä»»æ„ HTTP webhook</li>
                                <li><strong>Slack</strong>: éœ€è¦é…ç½® webhook URL</li>
                            </ul>

                            <h4 className="text-base font-medium mt-4 mb-2">API ç­¾åè¯´æ˜</h4>
                            <p className="text-sm text-gray-700">
                                æ‰€æœ‰ API è¯·æ±‚éƒ½éœ€è¦ä½¿ç”¨ HMAC-SHA256 ç­¾åéªŒè¯ã€‚ç­¾åç”Ÿæˆè§„åˆ™ï¼š
                            </p>
                            <pre className="mt-2 p-3 bg-gray-100 rounded text-xs overflow-x-auto">
{`// 1. è·å–å½“å‰æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰
const timestamp = Date.now().toString();

// 2. æ„é€ ç­¾åå†…å®¹
// GET/DELETE: path + query
// POST/PUT: request body
const payload = method === 'GET' || method === 'DELETE'
  ? pathname + search
  : JSON.stringify(body);

// 3. ç”Ÿæˆç­¾å
const signature = HMAC-SHA256(timestamp + payload, apiKey);

// 4. æ·»åŠ è¯·æ±‚å¤´
headers['X-Timestamp'] = timestamp;
headers['X-Signature'] = signature;`}
                            </pre>
                        </div>
                    </Card>
                </div>
            );
        }

        // åŠ è½½ CryptoJS
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js';
        script.onload = () => {
            ReactDOM.render(<App />, document.getElementById('root'));
        };
        document.head.appendChild(script);
    </script>
</body>
</html>